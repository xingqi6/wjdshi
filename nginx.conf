# 错误日志
error_log /dev/stderr warn;

server {
    listen 7860;
    server_name localhost;

    # ==========================================
    # 隐形门逻辑
    # ==========================================
    
    # 1. 验证接口：/auth?key=密码
    location = /auth {
        # 这里用 ###PASSWORD### 做占位符，启动时会被 Python 替换成真密码
        if ($arg_key != "###PASSWORD###") {
            add_header Content-Type text/plain;
            return 401 "Access Denied: Wrong Key";
        }
        # 密码正确，种下 Cookie (有效期30天)
        add_header Set-Cookie "access_token=granted; Path=/; Max-Age=2592000; HttpOnly";
        # 跳转回首页
        return 302 /;
    }

    # 2. 主入口
    location / {
        # 检查是否有 Cookie，没有则显示伪装页
        if ($cookie_access_token != "granted") {
            add_header Content-Type text/plain;
            # 伪装成系统维护
            return 200 "System Maintenance Mode. Service is offline.";
        }

        # 有 Cookie，放行给 OpenList
        proxy_pass http://127.0.0.1:5244;
        
        # 彻底隐藏 OpenList 的鉴权头，防止浏览器误判
        proxy_hide_header WWW-Authenticate;
        proxy_set_header Authorization "";
        
        # 标准代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_buffering off;
        client_max_body_size 0;
    }
}
